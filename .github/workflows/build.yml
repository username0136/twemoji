name: Build Twemoji Android Font

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-pip imagemagick fontforge git cmake pkg-config libpng-dev zlib1g-dev
          export PATH="$HOME/.local/bin:$PATH"
          pip3 install --user fonttools pillow
          pip3 install --user git+https://github.com/googlefonts/nototools.git

      - name: Clone googlefonts/noto-emoji
        run: git clone https://github.com/googlefonts/noto-emoji.git

      - name: Make conversion script executable
        run: chmod +x scripts/convert_svgs.sh

      - name: Convert SVGs â†’ 128px PNGs
        run: ./scripts/convert_svgs.sh assets/svg noto-emoji/png

      - name: Show converted PNGs (debug)
        run: |
          find noto-emoji/png -type f -name '*.png' | head -n 20 || true
          echo "PNG count:" $(find noto-emoji/png -type f -name '*.png' | wc -l)

      - name: Build CBDT font
        env:
          PATH: ${{ github.workspace }}/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        run: |
          cd noto-emoji || exit 1

          # Try explicit CBDT target
          if grep -q "cbdt" Makefile; then
            make cbdt || true
          fi

          # Try python CBDT script if available
          if [ -f tools/build_cbdt.py ]; then
            python3 tools/build_cbdt.py || true
          fi

          # Fallback to full make
          make || true

          echo "Listing built TTFs:"
          find . -type f -name '*.ttf' -print || true

      - name: Upload built TTFs
        uses: actions/upload-artifact@v4
        with:
          name: twemoji-android-font
          path: |
            noto-emoji/fonts/*.ttf
            noto-emoji/out/*.ttf
            noto-emoji/build/*.ttf
            noto-emoji/*.ttf
            noto-emoji/**/build/*.ttf
            noto-emoji/**/out/*.ttf
            noto-emoji/**/fonts/*.ttf
